<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Modern E-Commerce Application</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Material+Icons" rel="stylesheet" />
<style>
  /* Reset and base */
  * {
    margin: 0; padding: 0; box-sizing: border-box;
  }
  body {
    font-family: 'Inter', sans-serif;
    background: #fff;
    color: #374151;
    line-height: 1.5;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }
  a {
    text-decoration: none;
    color: inherit;
  }
  button {
    cursor: pointer;
    font-family: inherit;
  }
  /* Scrollbar for desktop */
  ::-webkit-scrollbar {
    width: 10px;
    height: 10px;
  }
  ::-webkit-scrollbar-thumb {
    background: #a78bfa;
    border-radius: 5px;
  }
  ::-webkit-scrollbar-track {
    background: #f3f4f6;
  }

  /* HEADER */
  header {
    position: sticky;
    top: 0;
    background: #fff;
    border-bottom: 1px solid #e5e7eb;
    padding: 12px 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    z-index: 1000;
    box-shadow: 0 2px 6px rgb(124 58 237 / 0.1);
  }
  .logo {
    font-weight: 800;
    font-size: 1.75rem;
    color: #7c3aed;
    letter-spacing: -0.03em;
    user-select: none;
  }
  .header-center {
    flex: 1;
    padding: 0 24px;
  }
  .search-bar {
    width: 100%;
    max-width: 600px;
    position: relative;
  }
  .search-bar input {
    width: 100%;
    padding: 12px 48px 12px 16px;
    border-radius: 12px;
    border: 1.5px solid #d1d5db;
    outline-offset: 2px;
    font-size: 1rem;
    transition: border-color 0.3s ease;
  }
  .search-bar input:focus {
    border-color: #7c3aed;
    box-shadow: 0 0 6px 2px rgba(124, 58, 237, 0.3);
  }
  .search-icon {
    position: absolute;
    right: 14px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 20px;
    color: #9ca3af;
    pointer-events: none;
  }
  nav.header-nav {
    display: flex;
    align-items: center;
    gap: 24px;
  }
  nav.header-nav a {
    font-weight: 600;
    font-size: 1rem;
    color: #6b7280;
    position: relative;
    padding: 6px 8px;
    border-radius: 8px;
    transition: background-color 0.3s, color 0.3s;
  }
  nav.header-nav a:hover, nav.header-nav a.active {
    background-color: #7c3aed;
    color: white;
  }
  /* Cart icon with count badge */
  .cart-button {
    position: relative;
    background: none;
    border: none;
    color: #6b7280;
    font-size: 28px;
    display: flex;
    align-items: center;
    transition: color 0.3s;
  }
  .cart-button:hover {
    color: #7c3aed;
  }
  .cart-count {
    position: absolute;
    top: 0;
    right: 0;
    background: #7c3aed;
    color: white;
    border-radius: 9999px;
    font-size: 12px;
    font-weight: 700;
    min-width: 20px;
    padding: 2px 6px;
    display: flex;
    justify-content: center;
    align-items: center;
    transform: translate(50%, -50%);
    user-select: none;
  }

  /* MAIN LAYOUT */
  main {
    flex: 1;
    display: grid;
    grid-template-columns: 300px 1fr 350px;
    gap: 24px;
    max-width: 1200px;
    margin: 24px auto;
    padding: 0 24px 48px;
  }
  @media (max-width: 1024px) {
    main {
      grid-template-columns: 300px 1fr;
      max-width: 900px;
    }
  }
  @media (max-width: 768px) {
    main {
      grid-template-columns: 1fr;
      max-width: 100%;
      margin: 24px 16px 48px;
    }
  }

  /* LEFT SIDEBAR - Filters */
  .sidebar {
    background: #f9fafb;
    border-radius: 12px;
    padding: 16px 20px;
    box-shadow: 0 2px 8px rgb(0 0 0 / 0.05);
    height: fit-content;
    max-height: calc(100vh - 130px);
    overflow-y: auto;
    user-select: none;
  }
  .sidebar h3 {
    font-weight: 700;
    color: #4b5563;
    margin-bottom: 12px;
    font-size: 1.125rem;
    border-bottom: 1px solid #d1d5db;
    padding-bottom: 8px;
  }
  .filter-group {
    margin-bottom: 24px;
  }
  .filter-item {
    font-size: 0.95rem;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
  }
  .filter-item input[type="checkbox"] {
    cursor: pointer;
  }
  input[type="range"] {
    width: 100%;
    margin-top: 8px;
    -webkit-appearance: none;
    appearance: none;
    height: 8px;
    border-radius: 8px;
    background: #e0e7ff;
    outline: none;
    cursor: pointer;
  }
  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #7c3aed;
    cursor: pointer;
    box-shadow: 0 0 4px rgba(124, 58, 237, 0.6);
    transition: background-color 0.3s;
  }
  input[type="range"]::-webkit-slider-thumb:hover {
    background-color: #a78bfa;
  }

  /* MIDDLE - PRODUCT GRID */
  .product-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 20px;
  }
  .product-card {
    background: white;
    border-radius: 12px;
    padding: 16px;
    box-shadow: 0 2px 8px rgb(0 0 0 / 0.05);
    display: flex;
    flex-direction: column;
    transition: box-shadow 0.3s ease;
    cursor: pointer;
  }
  .product-card:hover {
    box-shadow: 0 8px 20px rgb(124 58 237 / 0.25);
  }
  .product-image {
    width: 100%;
    height: 180px;
    background-color: #ede9fe;
    border-radius: 12px;
    overflow: hidden;
    position: relative;
  }
  .product-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
  }
  .product-card:hover .product-image img {
    transform: scale(1.1);
  }
  .product-info {
    flex: 1;
    padding-top: 16px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }
  .product-name {
    font-weight: 700;
    font-size: 1rem;
    margin-bottom: 4px;
    color: #1f2937;
  }
  .product-category {
    font-size: 0.8rem;
    color: #9ca3af;
    margin-bottom: 8px;
  }
  .product-price {
    font-weight: 700;
    font-size: 1.125rem;
    color: #7c3aed;
  }
  .product-rating {
    display: flex;
    align-items: center;
    gap: 4px;
    margin-bottom: 12px;
  }
  .star {
    color: #fbbf24;
    font-size: 18px;
  }
  .star.empty {
    color: #d1d5db;
  }
  .quick-actions {
    display: flex;
    gap: 12px;
  }
  .btn-small {
    background: #7c3aed;
    color: white;
    border-radius: 8px;
    padding: 6px 12px;
    font-weight: 700;
    font-size: 0.9rem;
    border: none;
    transition: background-color 0.3s;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .btn-small:hover {
    background-color: #a78bfa;
  }
  /* Pagination */
  .pagination {
    margin-top: 24px;
    display: flex;
    justify-content: center;
    gap: 12px;
  }
  .page-btn {
    background: none;
    border: 1.5px solid #d1d5db;
    border-radius: 8px;
    padding: 8px 16px;
    font-weight: 600;
    color: #6b7280;
    transition: background-color 0.3s, border-color 0.3s;
  }
  .page-btn:hover {
    border-color: #7c3aed;
    color: #7c3aed;
  }
  .page-btn.active {
    background-color: #7c3aed;
    color: white;
    border-color: #7c3aed;
  }

  /* RIGHT SIDEBAR - CART */
  .cart-sidebar {
    background: #f9fafb;
    border-radius: 12px;
    padding: 16px 20px;
    box-shadow: 0 2px 8px rgb(0 0 0 / 0.05);
    height: calc(100vh - 130px);
    display: flex;
    flex-direction: column;
    position: sticky;
    top: 70px;
  }
  .cart-header {
    font-weight: 700;
    font-size: 1.25rem;
    margin-bottom: 16px;
    color: #4b5563;
    user-select: none;
  }
  .cart-items {
    flex: 1;
    overflow-y: auto;
    margin-bottom: 16px;
  }
  .cart-item {
    display: flex;
    gap: 12px;
    align-items: center;
    margin-bottom: 12px;
    padding-bottom: 12px;
    border-bottom: 1px solid #e5e7eb;
  }
  .cart-item-image {
    width: 64px;
    height: 64px;
    border-radius: 12px;
    overflow: hidden;
    background-color: #ede9fe;
    flex-shrink: 0;
  }
  .cart-item-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .cart-item-info {
    flex: 1;
  }
  .cart-item-name {
    font-weight: 700;
    font-size: 1rem;
    color: #1f2937;
    margin-bottom: 4px;
  }
  .cart-item-variant {
    font-size: 0.85rem;
    color: #6b7280;
    margin-bottom: 8px;
  }
  .cart-item-price {
    font-weight: 700;
    color: #7c3aed;
  }
  .quantity-controls {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .quantity-btn {
    width: 28px;
    height: 28px;
    border-radius: 8px;
    border: 1.5px solid #d1d5db;
    background: white;
    color: #6b7280;
    font-size: 20px;
    line-height: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    transition: background-color 0.3s, border-color 0.3s;
  }
  .quantity-btn:hover {
    background-color: #7c3aed;
    border-color: #7c3aed;
    color: white;
  }
  .quantity-display {
    min-width: 32px;
    text-align: center;
    font-weight: 600;
  }
  .cart-footer {
    border-top: 1.5px solid #e5e7eb;
    padding-top: 16px;
  }
  .cart-total {
    font-weight: 800;
    font-size: 1.25rem;
    color: #7c3aed;
    margin-bottom: 12px;
  }
  .checkout-btn {
    width: 100%;
    background-color: #7c3aed;
    color: white;
    font-weight: 700;
    font-size: 1.125rem;
    padding: 14px 0;
    border-radius: 12px;
    border: none;
    transition: background-color 0.3s ease;
  }
  .checkout-btn:hover {
    background-color: #a78bfa;
  }
  /* Disabled button */
  .checkout-btn:disabled {
    background-color: #c7d2fe;
    cursor: default;
  }

  /* MODALS */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background-color: rgba(0,0,0,0.5);
    z-index: 2000;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .modal {
    background: white;
    border-radius: 16px;
    width: 90%;
    max-width: 900px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 12px 24px rgb(124 58 237 / 0.3);
    position: relative;
    padding: 24px 32px 32px;
  }
  .modal-close-btn {
    position: absolute;
    top: 16px;
    right: 16px;
    background: none;
    border: none;
    font-size: 28px;
    color: #6b7280;
    cursor: pointer;
    transition: color 0.3s ease;
  }
  .modal-close-btn:hover {
    color: #7c3aed;
  }
  /* Product Detail Modal */
  .product-detail-main {
    display: flex;
    flex-wrap: wrap;
    gap: 32px;
  }
  .gallery {
    flex: 1 1 45%;
    min-width: 280px;
  }
  .gallery-main-image {
    width: 100%;
    border-radius: 16px;
    overflow: hidden;
    background-color: #ede9fe;
    margin-bottom: 12px;
    height: 330px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .gallery-main-image img {
    width: 100%;
    object-fit: contain;
    max-height: 100%;
  }
  .gallery-thumbnails {
    display: flex;
    gap: 12px;
  }
  .thumbnail {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    overflow: hidden;
    cursor: pointer;
    border: 2px solid transparent;
    background-color: #ede9fe;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: border-color 0.3s;
  }
  .thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .thumbnail.selected {
    border-color: #7c3aed;
  }
  .product-detail-info {
    flex: 1 1 45%;
    min-width: 280px;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }
  .product-detail-name {
    font-weight: 800;
    font-size: 1.75rem;
    color: #1f2937;
  }
  .product-detail-category {
    font-size: 0.95rem;
    color: #6b7280;
  }
  .product-detail-price {
    font-weight: 800;
    font-size: 1.5rem;
    color: #7c3aed;
  }
  .product-detail-description {
    font-size: 1rem;
    color: #374151;
    white-space: pre-wrap;
  }
  .variant-selector {
    margin-top: 8px;
    user-select: none;
  }
  .variant-label {
    font-weight: 600;
    margin-bottom: 6px;
    display: block;
    color: #4b5563;
  }
  .variant-options {
    display: flex;
    gap: 12px;
  }
  .variant-option {
    cursor: pointer;
    padding: 8px 16px;
    border-radius: 12px;
    border: 1.5px solid #d1d5db;
    font-weight: 600;
    transition: background-color 0.3s, border-color 0.3s;
    user-select: none;
  }
  .variant-option:hover {
    border-color: #7c3aed;
  }
  .variant-option.selected {
    background-color: #7c3aed;
    border-color: #7c3aed;
    color: white;
  }
  .add-to-cart-section {
    margin-top: auto;
    display: flex;
    gap: 16px;
    align-items: center;
  }
  .quantity-input {
    width: 60px;
    padding: 8px 12px;
    border-radius: 12px;
    border: 1.5px solid #d1d5db;
    font-weight: 700;
    font-size: 1rem;
    text-align: center;
    outline-offset: 2px;
    transition: border-color 0.3s ease;
  }
  .quantity-input:focus {
    border-color: #7c3aed;
    box-shadow: 0 0 6px 2px rgba(124, 58, 237, 0.3);
  }
  .btn-primary {
    background-color: #7c3aed;
    border: none;
    color: white;
    padding: 14px 32px;
    border-radius: 12px;
    font-weight: 700;
    font-size: 1.125rem;
    transition: background-color 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .btn-primary:hover:not(:disabled) {
    background-color: #a78bfa;
  }
  .btn-primary:disabled {
    background-color: #c7d2fe;
    cursor: not-allowed;
  }
  /* Reviews Section */
  .reviews {
    margin-top: 32px;
  }
  .reviews-header {
    font-weight: 700;
    font-size: 1.25rem;
    margin-bottom: 16px;
    color: #4b5563;
  }
  .review-item {
    border-bottom: 1.5px solid #e5e7eb;
    padding: 12px 0;
  }
  .review-author {
    font-weight: 700;
    color: #1f2937;
    font-size: 1rem;
  }
  .review-rating {
    display: flex;
    gap: 4px;
    margin: 4px 0 8px;
  }
  .review-comment {
    font-size: 0.95rem;
    color: #4b5563;
    white-space: pre-wrap;
  }
  /* Form Styles for checkout */
  form.checkout-form {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }
  label {
    display: flex;
    flex-direction: column;
    font-weight: 600;
    font-size: 0.95rem;
    color: #4b5563;
    user-select: none;
  }
  input, select, textarea {
    margin-top: 6px;
    padding: 10px 14px;
    border: 1.5px solid #d1d5db;
    border-radius: 12px;
    font-size: 1rem;
    outline-offset: 2px;
    transition: border-color 0.3s ease;
    font-family: inherit;
  }
  input:focus, select:focus, textarea:focus {
    border-color: #7c3aed;
    box-shadow: 0 0 6px 2px rgba(124, 58, 237, 0.3);
  }
  textarea {
    resize: vertical;
  }
  .error-message {
    font-size: 0.9rem;
    color: #dc2626;
    margin-top: 4px;
    user-select: none;
  }
  /* Step progress bar for checkout */
  .checkout-steps {
    display: flex;
    gap: 24px;
    justify-content: center;
    margin-bottom: 24px;
    user-select: none;
  }
  .step {
    flex: 1;
    position: relative;
    padding: 8px 0 8px 0;
    color: #9ca3af;
    font-weight: 700;
    font-size: 0.85rem;
    text-align: center;
    cursor: default;
  }
  .step::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 0;
    width: 100%;
    height: 4px;
    background-color: #e5e7eb;
    border-radius: 4px;
    transform: translateY(-50%);
    z-index: 0;
  }
  .step:first-child::before {
    left: 50%;
    width: 50%;
  }
  .step:last-child::before {
    width: 50%;
  }
  .step.active, .step.completed {
    color: #7c3aed;
    cursor: pointer;
  }
  .step.active::before, .step.completed::before {
    background-color: #7c3aed;
  }
  .step-indicator {
    position: relative;
    z-index: 1;
    background-color: white;
    padding: 2px 8px;
    border-radius: 12px;
  }
  /* Wishlist button */
  .btn-wishlist {
    background-color: #f9fafb;
    border: 1.5px solid #d1d5db;
    padding: 10px 14px;
    border-radius: 12px;
    font-weight: 700;
    font-size: 1rem;
    color: #7c3aed;
    cursor: pointer;
    user-select: none;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: background-color 0.3s, border-color 0.3s;
  }
  .btn-wishlist:hover {
    background-color: #7c3aed;
    color: white;
    border-color: #7c3aed;
  }

  /* Toast notifications */
  #toast-container {
    position: fixed;
    bottom: 24px;
    right: 24px;
    z-index: 3000;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  .toast {
    background-color: #7c3aed;
    color: white;
    padding: 14px 20px;
    border-radius: 16px;
    font-weight: 700;
    box-shadow: 0 8px 20px rgba(124, 58, 237, 0.4);
    opacity: 0;
    animation: slideInUp 0.4s forwards;
    user-select: none;
  }
  @keyframes slideInUp {
    from { transform: translateY(24px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }

  /* Product recommendations and recently viewed */
  .recommendations, .recently-viewed {
    margin-top: 24px;
  }
  .section-title {
    font-weight: 700;
    font-size: 1.25rem;
    color: #4b5563;
    margin-bottom: 16px;
    user-select: none;
  }

  /* Responsive tweaks */
  @media (max-width: 768px) {
    .sidebar {
      max-height: none;
      position: static;
      height: auto;
    }
    .cart-sidebar {
      position: static;
      height: auto;
      margin-top: 24px;
    }
    .product-detail-main {
      flex-direction: column;
    }
    .gallery,
    .product-detail-info {
      flex: 1 1 100%;
    }
  }
</style>
</head>
<body>
  <header role="banner" aria-label="Main header">
    <div class="logo" tabindex="0" aria-label="Site Logo - Modern Shop">ModernShop</div>
    <div class="header-center">
      <div class="search-bar" role="search" aria-label="Product search">
        <input type="search" id="global-search" placeholder="Search products..." aria-autocomplete="list" aria-controls="search-suggestions" aria-haspopup="listbox" />
        <span class="material-icons search-icon" aria-hidden="true">search</span>
        <ul id="search-suggestions" role="listbox" hidden></ul>
      </div>
    </div>
    <nav class="header-nav" aria-label="Primary">
      <a href="#" id="nav-home" class="nav-link active" tabindex="0">Home</a>
      <a href="#" id="nav-account" class="nav-link" tabindex="0">Account</a>
    </nav>
    <button class="cart-button" aria-label="View cart" id="cart-button">
      <span class="material-icons" aria-hidden="true">shopping_cart</span>
      <div class="cart-count" aria-live="polite" aria-atomic="true" id="cart-count">0</div>
    </button>
  </header>

  <main>
    <!-- Filters Sidebar -->
    <aside class="sidebar" aria-label="Product filters">
      <div class="filter-group" id="filter-category">
        <h3>Categories</h3>
        <!-- Dynamically rendered -->
      </div>
      <div class="filter-group" id="filter-price">
        <h3>Price Range</h3>
        <div>
          <label for="price-min">Min: <output id="price-min-output">0</output> $</label>
          <input type="range" id="price-min" min="0" max="2000" step="10" value="0" aria-valuemin="0" aria-valuemax="2000" aria-valuenow="0" />
        </div>
        <div style="margin-top:12px;">
          <label for="price-max">Max: <output id="price-max-output">2000</output> $</label>
          <input type="range" id="price-max" min="0" max="2000" step="10" value="2000" aria-valuemin="0" aria-valuemax="2000" aria-valuenow="2000" />
        </div>
      </div>
      <div class="filter-group" id="filter-rating">
        <h3>Minimum Rating</h3>
        <!-- Ratings checkboxes 1-5 -->
      </div>
      <div class="filter-group" id="filter-brand">
        <h3>Brands</h3>
        <!-- Rendered brands -->
      </div>
    </aside>

    <!-- Product Grid and sorting -->
    <section aria-label="Products and sorting">
      <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom: 20px;">
        <div>
          <label for="sort-select" style="font-weight: 600; user-select:none;">Sort by:</label>
          <select id="sort-select" aria-label="Sort products">
            <option value="popularity">Popularity</option>
            <option value="price-low-high">Price: Low to High</option>
            <option value="price-high-low">Price: High to Low</option>
            <option value="rating-high-low">Rating: High to Low</option>
            <option value="newest">Newest Arrivals</option>
          </select>
        </div>
        <div id="pagination" aria-label="Pagination controls" role="navigation" aria-live="polite"></div>
      </div>
      <div class="product-grid" id="product-grid" tabindex="0" aria-live="polite" aria-atomic="true" aria-relevant="additions removals"></div>

      <!-- Recommendations -->
      <section class="recommendations" aria-label="Recommended products" hidden>
        <h3 class="section-title">Recommended for you</h3>
        <div class="product-grid" id="recommendations-grid"></div>
      </section>

      <!-- Recently Viewed -->
      <section class="recently-viewed" aria-label="Recently viewed products" hidden>
        <h3 class="section-title">Recently Viewed</h3>
        <div class="product-grid" id="recently-viewed-grid"></div>
      </section>
    </section>

    <!-- Cart Sidebar -->
    <aside class="cart-sidebar" aria-label="Shopping cart">
      <div class="cart-header">Your Cart</div>
      <div class="cart-items" id="cart-items" tabindex="0" aria-live="polite" aria-atomic="true" aria-relevant="additions removals"></div>
      <div class="cart-footer">
        <div class="cart-total" aria-live="polite" aria-atomic="true" id="cart-total">$0.00</div>
        <button class="checkout-btn" id="btn-checkout" disabled>Proceed to Checkout</button>
      </div>
    </aside>
  </main>

  <!-- Modals -->
  <div id="modal-root" aria-live="assertive"></div>

  <!-- Toast Notifications -->
  <div id="toast-container" aria-live="polite" aria-atomic="true"></div>

<script>
(function() {
  // =============== DATA STRUCTURES ===============
  const products = [
    {
      id: 'p1',
      name: 'Elegant Wireless Headphones',
      description: 'Experience high-quality sound with these elegant wireless headphones featuring noise cancellation and 20 hours battery life.',
      price: 199.99,
      images: [
        'https://placehold.co/600x400/7c3aed/ffffff?text=Wireless+Headphones+1',
        'https://placehold.co/600x400/9f7aea/ffffff?text=Wireless+Headphones+2',
        'https://placehold.co/600x400/b794f4/000000?text=Wireless+Headphones+3'
      ],
      category: 'Audio',
      brand: 'SoundMax',
      rating: 4.7,
      reviews: ['r1','r3'],
      stock: 12,
      variants: [
        {id:'v1', name:'Black', price: 199.99},
        {id:'v2', name:'White', price: 209.99}
      ],
      tags: ['wireless', 'headphones', 'audio']
    },
    {
      id: 'p2',
      name: 'Smart Fitness Watch',
      description: 'Monitor your health and stay connected with the Smart Fitness Watch packed with features and a sleek design.',
      price: 149.99,
      images: [
        'https://placehold.co/600x400/7c3aed/ffffff?text=Fitness+Watch+1',
        'https://placehold.co/600x400/785ef0/ffffff?text=Fitness+Watch+2'
      ],
      category: 'Wearables',
      brand: 'FitNext',
      rating: 4.3,
      reviews: ['r2'],
      stock: 30,
      variants: [
        {id:'v3', name:'Standard', price: 149.99},
        {id:'v4', name:'Premium', price: 179.99}
      ],
      tags: ['smartwatch', 'fitness', 'wearables']
    },
    {
      id: 'p3',
      name: 'Wireless Bluetooth Speaker',
      description: 'Portable Bluetooth speaker with powerful sound and bass boosts, perfect for outdoor and indoor use.',
      price: 89.99,
      images: [
        'https://placehold.co/600x400/7c3aed/ffffff?text=Bluetooth+Speaker+1',
        'https://placehold.co/600x400/a78bfa/ffffff?text=Bluetooth+Speaker+2'
      ],
      category: 'Audio',
      brand: 'ClearSound',
      rating: 4.1,
      reviews: [],
      stock: 5,
      variants: [],
      tags: ['speaker', 'bluetooth', 'wireless']
    },
    {
      id: 'p4',
      name: 'Stylish Laptop Backpack',
      description: 'Durable and stylish backpack designed for carrying your laptop and accessories with comfort and style.',
      price: 69.50,
      images: [
        'https://placehold.co/600x400/7c3aed/ffffff?text=Laptop+Backpack+1',
        'https://placehold.co/600x400/9f7aea/ffffff?text=Laptop+Backpack+2'
      ],
      category: 'Accessories',
      brand: 'UrbanGear',
      rating: 4.9,
      reviews: ['r4'],
      stock: 0,
      variants: [
        {id: 'v5', name: 'Black', price: 69.5},
        {id: 'v6', name: 'Grey', price: 74.9}
      ],
      tags: ['backpack', 'laptop', 'accessories']
    },
    {
      id: 'p5',
      name: 'Ergonomic Office Chair',
      description: 'Comfortable ergonomic chair with adjustable height and lumbar support for long hours at work.',
      price: 310.00,
      images: [
        'https://placehold.co/600x400/7c3aed/ffffff?text=Office+Chair+1',
        'https://placehold.co/600x400/a78bfa/ffffff?text=Office+Chair+2'
      ],
      category: 'Furniture',
      brand: 'SitWell',
      rating: 4.6,
      reviews: ['r5'],
      stock: 8,
      variants: [],
      tags: ['office', 'chair', 'ergonomic']
    },
    {
      id: 'p6',
      name: 'Stylish Sunglasses',
      description: 'UV protection sunglasses with a sleek design perfect for summer outings.',
      price: 49.99,
      images: [
        'https://placehold.co/600x400/7c3aed/ffffff?text=Sunglasses+1',
        'https://placehold.co/600x400/9f7aea/ffffff?text=Sunglasses+2'
      ],
      category: 'Accessories',
      brand: 'SunGuard',
      rating: 3.9,
      reviews: [],
      stock: 25,
      variants: [
        {id:'v7', name:'Black Frame', price: 49.99},
        {id:'v8', name:'Brown Frame', price: 59.99}
      ],
      tags: ['sunglasses', 'uv protection', 'accessories']
    }
    // Add more products as needed for pagination
  ];

  const reviews = [
    {id: 'r1', productId: 'p1', userId: 'u1', rating: 5, comment: 'Fantastic sound quality and battery life.', helpful: 12, verified: true, createdAt: '2023-09-01T08:20:00Z'},
    {id: 'r2', productId: 'p2', userId: 'u2', rating: 4, comment: 'Trackers are accurate and the screen is crisp.', helpful: 8, verified: true, createdAt: '2023-08-28T12:45:00Z'},
    {id: 'r3', productId: 'p1', userId: 'u3', rating: 4, comment: 'Comfortable and stylish.', helpful: 4, verified: false, createdAt: '2023-08-30T15:30:00Z'},
    {id: 'r4', productId: 'p4', userId: 'u4', rating: 5, comment: 'Great space and very comfortable straps.', helpful: 10, verified: true, createdAt: '2023-09-10T10:00:00Z'},
    {id: 'r5', productId: 'p5', userId: 'u5', rating: 5, comment: 'Very comfortable and supportive.', helpful: 15, verified: true, createdAt: '2023-09-15T09:15:00Z'}
  ];

  const users = [
    {
      id: 'u1',
      email: 'alice@example.com',
      name: 'Alice Johnson',
      addresses: ['123 Main St, Springfield'],
      paymentMethods: ['Visa **** 1234'],
      wishlist: ['p6', 'p2'],
      orderHistory: []
    }
  ];

  let orders = [];

  // Cart stored in-memory and in localStorage
  let cart = JSON.parse(localStorage.getItem('cart')) || [];

  // Wishlist stored in localStorage
  let wishlist = JSON.parse(localStorage.getItem('wishlist')) || [];

  // Recently viewed products stored in sessionStorage
  let recentlyViewed = JSON.parse(sessionStorage.getItem('recentlyViewed')) || [];

  // Browsing history for recommendations stored in sessionStorage
  let browsingHistory = JSON.parse(sessionStorage.getItem('browsingHistory')) || [];

  // =============== STATE ===============
  let productFilters = {
    category: new Set(),
    priceMin: 0,
    priceMax: 2000,
    minRating: 0,
    brands: new Set()
  };
  let sorting = 'popularity';
  let pagination = {
    currentPage: 1,
    pageSize: 6,
    totalItems: 0,
    totalPages: 1
  };
  let filteredProducts = [];

  // Currently viewed product in product detail modal
  let currentProductDetail = null;
  let currentProductVariantId = null;

  // Current logged in user (simulate)
  let currentUser = users[0] || null;

  // Checkout step states
  let checkoutStep = 0; // 0 = cart, 1 = shipping & billing form, 2 = payment, 3 = confirmation
  let currentOrder = null;


  // =============== UTILITIES ===============
  function formatPrice(price) {
    return '$' + price.toFixed(2);
  }
  function createElement(tag, options = {}) {
    const el = document.createElement(tag);
    if (options.classes) el.className = options.classes;
    if (options.text) el.textContent = options.text;
    if (options.html) el.innerHTML = options.html;
    if (options.attrs) {
      for (const [k,v] of Object.entries(options.attrs)) {
        if(v === false) continue;
        if(v === true) el.setAttribute(k, '');
        else el.setAttribute(k,v);
      }
    }
    if (options.events) {
      for (const [e,fn] of Object.entries(options.events)) {
        el.addEventListener(e, fn);
      }
    }
    return el;
  }
  function delay(ms = 250) {
    return new Promise(res => setTimeout(res, ms));
  }

  // Generate unique id, fallback for crypto.randomUUID
  function uuid() {
    if (crypto.randomUUID) return crypto.randomUUID();
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
      var r = Math.random()*16|0, v = c=='x'?r:(r&0x3|0x8);
      return v.toString(16);
    });
  }

  // Toast notification
  function showToast(message, timeout=3500) {
    const container = document.getElementById('toast-container');
    const toast = createElement('div', {classes: 'toast', text: message});
    container.appendChild(toast);
    setTimeout(() => {
      toast.style.opacity = '0';
      setTimeout(() => container.removeChild(toast), 500);
    }, timeout);
  }

  // Find user by id
  function getUserById(id) {
    return users.find(u => u.id === id);
  }

  // =============== RENDER FILTERS ===============
  function renderFilters() {
    // Categories based on products
    const categoryContainer = document.getElementById('filter-category');
    categoryContainer.innerHTML = '<h3>Categories</h3>';
    const categories = Array.from(new Set(products.map(p => p.category))).sort();
    categories.forEach(cat => {
      const div = createElement('div', {classes:'filter-item'});
      const checkbox = createElement('input', {attrs:{type:'checkbox', id:'cat-' + cat}});
      checkbox.checked = productFilters.category.has(cat);
      checkbox.addEventListener('change', e => {
        if (e.target.checked) productFilters.category.add(cat);
        else productFilters.category.delete(cat);
        applyFilters();
      });
      const label = createElement('label', {text: cat, attrs: {for:'cat-'+cat}});
      div.appendChild(checkbox);
      div.appendChild(label);
      categoryContainer.appendChild(div);
    });

    // Price sliders min and max
    const priceMinInput = document.getElementById('price-min');
    const priceMaxInput = document.getElementById('price-max');
    const priceMinOutput = document.getElementById('price-min-output');
    const priceMaxOutput = document.getElementById('price-max-output');

    priceMinInput.value = productFilters.priceMin;
    priceMaxInput.value = productFilters.priceMax;
    priceMinOutput.textContent = productFilters.priceMin;
    priceMaxOutput.textContent = productFilters.priceMax;

    priceMinInput.min = 0;
    priceMinInput.max = 2000;
    priceMinInput.step = 10;

    priceMaxInput.min = 0;
    priceMaxInput.max = 2000;
    priceMaxInput.step = 10;

    priceMinInput.addEventListener('input', e => {
      let val = Number(e.target.value);
      if (val > productFilters.priceMax) {
        val = productFilters.priceMax;
        e.target.value = val;
      }
      productFilters.priceMin = val;
      priceMinOutput.textContent = val;
      applyFilters();
    });
    priceMaxInput.addEventListener('input', e => {
      let val = Number(e.target.value);
      if (val < productFilters.priceMin) {
        val = productFilters.priceMin;
        e.target.value = val;
      }
      productFilters.priceMax = val;
      priceMaxOutput.textContent = val;
      applyFilters();
    });

    // Rating filters 1-5 minimum rating
    const ratingContainer = document.getElementById('filter-rating');
    ratingContainer.innerHTML = '<h3>Minimum Rating</h3>';
    for(let i=5; i>=1; i--) {
      const div = createElement('div', {classes:'filter-item'});
      const radio = createElement('input', {attrs: {type:'radio', name:'rating-filter', id:'rating-'+i, value:i}});
      radio.checked = productFilters.minRating === i;
      radio.addEventListener('change', e => {
        productFilters.minRating = Number(e.target.value);
        applyFilters();
      });
      const label = createElement('label', {attrs: {for:'rating-'+i}});
      // Stars display
      for(let j=1; j<=5; j++) {
        label.innerHTML += `<span class="material-icons star" aria-hidden="true">${j<=i ? 'star' : 'star_outline'}</span>`;
      }
      div.appendChild(radio);
      div.appendChild(label);
      ratingContainer.appendChild(div);
    }
    // Add an option for no minimum rating (show all)
    const div = createElement('div', {classes:'filter-item'});
    const radio = createElement('input', {attrs: {type:'radio', name:'rating-filter', id:'rating-0', value:0}});
    radio.checked = productFilters.minRating === 0;
    radio.addEventListener('change', e => {
      productFilters.minRating = 0;
      applyFilters();
    });
    const label = createElement('label', {attrs: {for:'rating-0'}, text: 'All Ratings' });
    div.appendChild(radio);
    div.appendChild(label);
    ratingContainer.appendChild(div);

    // Brands filters
    const brandContainer = document.getElementById('filter-brand');
    brandContainer.innerHTML = '<h3>Brands</h3>';
    const brandSet = new Set(products.map(p => p.brand));
    Array.from(brandSet).sort().forEach(brand => {
      const div = createElement('div', {classes:'filter-item'});
      const checkbox = createElement('input', {attrs: {type:'checkbox', id:'brand-'+brand}});
      checkbox.checked = productFilters.brands.has(brand);
      checkbox.addEventListener('change', e => {
        if (e.target.checked) productFilters.brands.add(brand);
        else productFilters.brands.delete(brand);
        applyFilters();
      });
      const label = createElement('label', {attrs: {for:'brand-'+brand}, text: brand});
      div.appendChild(checkbox);
      div.appendChild(label);
      brandContainer.appendChild(div);
    });
  }

  // =========== APPLY FILTERS AND RENDER PRODUCTS ===========
  function applyFilters() {
    // Filter products by category, price, rating, brand
    filteredProducts = products.filter(p => {
      const matchCategory = productFilters.category.size === 0 || productFilters.category.has(p.category);
      const matchPrice = p.price >= productFilters.priceMin && p.price <= productFilters.priceMax;
      const matchRating = p.rating >= productFilters.minRating;
      const matchBrand = productFilters.brands.size === 0 || productFilters.brands.has(p.brand);
      return matchCategory && matchPrice && matchRating && matchBrand;
    });

    // Sort products
    switch(sorting) {
      case 'popularity':
        filteredProducts.sort((a,b) => b.rating - a.rating); // popularity by rating for demo
        break;
      case 'price-low-high':
        filteredProducts.sort((a,b) => a.price - b.price);
        break;
      case 'price-high-low':
        filteredProducts.sort((a,b) => b.price - a.price);
        break;
      case 'rating-high-low':
        filteredProducts.sort((a,b) => b.rating - a.rating);
        break;
      case 'newest':
        filteredProducts.sort((a,b) => 0); // no date data, skip
        break;
    }

    // Pagination
    pagination.totalItems = filteredProducts.length;
    pagination.totalPages = Math.ceil(pagination.totalItems / pagination.pageSize);
    if(pagination.currentPage > pagination.totalPages) pagination.currentPage = pagination.totalPages || 1;

    renderProducts();
    renderPagination();
  }

  // =========== RENDER PRODUCTS ===========
  function renderProducts() {
    const grid = document.getElementById('product-grid');
    grid.innerHTML = '';
    if(filteredProducts.length === 0) {
      grid.textContent = 'No products match the selected filters.';
      return;
    }
    const startIndex = (pagination.currentPage -1) * pagination.pageSize;
    const pageItems = filteredProducts.slice(startIndex, startIndex + pagination.pageSize);
    pageItems.forEach(product => {
      const card = createElement('article', {classes: 'product-card', attrs: {tabindex: 0, 'aria-label': `View details for ${product.name}`}});
      card.addEventListener('click', () => openProductDetail(product.id));
      card.addEventListener('keydown', e => {
        if(e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          openProductDetail(product.id);
        }
      });

      const imgDiv = createElement('div', {classes:'product-image'});
      const img = createElement('img', {attrs: {src: product.images[0], alt: product.name + ' product image'}});
      imgDiv.appendChild(img);
      card.appendChild(imgDiv);

      const info = createElement('div', {classes: 'product-info'});
      const name = createElement('header', {classes:'product-name', text: product.name });
      info.appendChild(name);
      info.appendChild(createElement('div', {classes:'product-category', text: product.category}));

      // Rating stars
      const ratingDiv = createElement('div', {classes:'product-rating'});
      for(let i=1; i<=5; i++) {
        const starSpan = createElement('span', {
          classes: 'star' + (i <= Math.round(product.rating) ? '' : ' empty'),
          html: '<span class="material-icons" aria-hidden="true">' + (i <= Math.round(product.rating) ? 'star' : 'star_outline') + '</span>'
        });
        ratingDiv.appendChild(starSpan);
      }
      info.appendChild(ratingDiv);
      // Price
      info.appendChild(createElement('div', {classes: 'product-price', text: formatPrice(product.price)}));

      // Quick action buttons container
      const quickActions = createElement('div', {classes:'quick-actions'});
      // Add to cart button
      const btnAddCart = createElement('button', {classes:'btn-small', text:'Add to Cart', attrs: {type:'button', 'aria-label': 'Add ' + product.name + ' to cart'}});
      btnAddCart.addEventListener('click', e => {
        e.stopPropagation();
        addToCart(product.id, product.variants[0]?.id || null, 1);
      });
      quickActions.appendChild(btnAddCart);

      // Wishlist button
      const btnWishlist = createElement('button', {classes:'btn-small', text:'â™¡', attrs: {type:'button', 'aria-label': 'Add to wishlist'}});
      btnWishlist.style.fontSize = '20px';
      btnWishlist.addEventListener('click', e => {
        e.stopPropagation();
        toggleWishlist(product.id);
      });
      // Highlight if on wishlist
      if(wishlist.includes(product.id)) btnWishlist.style.color = '#7c3aed';
      quickActions.appendChild(btnWishlist);

      info.appendChild(quickActions);
      card.appendChild(info);
      grid.appendChild(card);
    });
  }

  // =========== RENDER PAGINATION ===============
  function renderPagination() {
    const container = document.getElementById('pagination');
    container.innerHTML = '';
    if(pagination.totalPages <= 1) return;

    for(let i=1; i<=pagination.totalPages; i++) {
      const btn = createElement('button', {classes: 'page-btn ' + (pagination.currentPage === i ? 'active' : ''), text: i.toString(), attrs: {type:'button', 'aria-label': `Page ${i}`}});
      btn.addEventListener('click', () => {
        pagination.currentPage = i;
        renderProducts();
        renderPagination();
      });
      container.appendChild(btn);
    }
  }

  // =========== ADD TO CART FUNCTION ===========
  function addToCart(productId, variantId = null, quantity = 1) {
    const product = products.find(p => p.id === productId);
    if (!product) {
      showToast('Product not found.');
      return;
    }
    // Find variant price or default
    const variant = product.variants?.find(v => v.id === variantId) || null;
    // Check stock (simplified, no variant stock)
    if(product.stock < quantity) {
      showToast('Insufficient stock for ' + product.name);
      return;
    }
    // Check if item already in cart
    const existingIndex = cart.findIndex(c => c.productId === productId && c.variantId === variantId);
    if(existingIndex >= 0) {
      cart[existingIndex].quantity += quantity;
    } else {
      cart.push({
        id: uuid(),
        productId,
        variantId,
        quantity,
        price: variant?.price || product.price,
        addedAt: (new Date()).toISOString()
      });
    }
    updateCart();
    showToast(`Added ${product.name} to cart.`);
  }

  // =========== UPDATE CART UI & STORAGE ===========
  function updateCart() {
    // Remove any zero quantity items
    cart = cart.filter(item => item.quantity > 0);

    // Persist to localStorage
    localStorage.setItem('cart', JSON.stringify(cart));

    // Update cart count
    const count = cart.reduce((acc, cur) => acc + cur.quantity, 0);
    document.getElementById('cart-count').textContent = count;

    // Render cart sidebar
    renderCartItems();

    // Enable/Disable checkout button
    document.getElementById('btn-checkout').disabled = cart.length === 0;
  }

  // =========== RENDER CART ITEMS ===========
  function renderCartItems() {
    const container = document.getElementById('cart-items');
    container.innerHTML = '';
    if(cart.length === 0) {
      container.textContent = 'Your cart is empty.';
      document.getElementById('cart-total').textContent = '$0.00';
      return;
    }
    let total = 0;
    cart.forEach(item => {
      const product = products.find(p => p.id === item.productId);
      if(!product) return;

      const variant = product.variants?.find(v => v.id === item.variantId) || null;
      const itemPrice = (variant?.price || product.price) * item.quantity;
      total += itemPrice;

      const cartItem = createElement('div', {classes:'cart-item'});
      const imgDiv = createElement('div', {classes:'cart-item-image'});
      const img = createElement('img', {attrs:{src: product.images[0], alt: product.name + ' cart image'}});
      imgDiv.appendChild(img);
      cartItem.appendChild(imgDiv);

      const info = createElement('div', {classes:'cart-item-info'});
      info.appendChild(createElement('div', {classes:'cart-item-name', text: product.name}));

      if(variant) info.appendChild(createElement('div', {classes:'cart-item-variant', text: variant.name }));

      info.appendChild(createElement('div', {classes:'cart-item-price', text: formatPrice(itemPrice)}));
      cartItem.appendChild(info);

      // Quantity controls
      const qtyControls = createElement('div', {classes:'quantity-controls'});
      const btnDec = createElement('button', {classes:'quantity-btn', text: '-', attrs: {'aria-label': `Decrease quantity of ${product.name}`}});
      btnDec.addEventListener('click', () => {
        changeCartQuantity(item.id, -1);
      });
      const qtyDisplay = createElement('div', {classes:'quantity-display', text: item.quantity.toString(), attrs:{'aria-live':'polite', 'aria-atomic':'true'}});
      const btnInc = createElement('button', {classes:'quantity-btn', text: '+', attrs: {'aria-label': `Increase quantity of ${product.name}`}});
      btnInc.addEventListener('click', () => {
        changeCartQuantity(item.id, 1);
      });
      qtyControls.appendChild(btnDec);
      qtyControls.appendChild(qtyDisplay);
      qtyControls.appendChild(btnInc);

      cartItem.appendChild(qtyControls);
      container.appendChild(cartItem);
    });
    document.getElementById('cart-total').textContent = formatPrice(total);
  }

  // Change cart quantity
  function changeCartQuantity(cartItemId, delta) {
    const index = cart.findIndex(item => item.id === cartItemId);
    if(index < 0) return;
    const item = cart[index];
    const product = products.find(p => p.id === item.productId);
    if(!product) return;
    let newQty = item.quantity + delta;
    if(newQty > product.stock) {
      showToast('No more stock available for ' + product.name);
      return;
    }
    if(newQty < 1) newQty = 0;
    cart[index].quantity = newQty;
    updateCart();
  }

  // =========== OPEN PRODUCT DETAIL MODAL ===========
  function openProductDetail(productId) {
    const product = products.find(p => p.id === productId);
    if(!product) return;
    currentProductDetail = product;
    currentProductVariantId = product.variants?.[0]?.id || null;
    addToBrowsingHistory(productId);
    renderProductDetailModal(product);
  }

  // =========== RENDER PRODUCT DETAIL MODAL ===========
  function renderProductDetailModal(product) {
    const modalRoot = document.getElementById('modal-root');
    modalRoot.innerHTML = '';
    const overlay = createElement('div', {classes:'modal-overlay'});
    overlay.tabIndex = -1;
    overlay.addEventListener('click', e => {
      if(e.target === overlay) closeModal();
    });
    // Trap focus within modal for accessibility
    overlay.addEventListener('keydown', e => {
      if(e.key === 'Escape') {
        e.preventDefault();
        closeModal();
      }
    });

    const modal = createElement('section', {classes:'modal', attrs: {role:'dialog', 'aria-modal':'true', 'aria-labelledby':'modal-title'}});
    // Close button
    const btnClose = createElement('button', {classes:'modal-close-btn', html:'<span class="material-icons" aria-hidden="true">close</span>', attrs:{'aria-label':'Close product detail'}});
    btnClose.addEventListener('click', closeModal);
    modal.appendChild(btnClose);

    const detailMain = createElement('div', {classes:'product-detail-main'});
    // Gallery
    const gallery = createElement('div', {classes:'gallery'});
    const mainImgDiv = createElement('div', {classes:'gallery-main-image'});
    const mainImg = createElement('img', {attrs: {src: product.images[0], alt: product.name + ' main image'}});
    mainImgDiv.appendChild(mainImg);
    gallery.appendChild(mainImgDiv);
    // Thumbnails
    const thumbnails = createElement('div', {classes:'gallery-thumbnails'});
    product.images.forEach((src, idx) => {
      const thumb = createElement('div', {classes:'thumbnail' + (idx === 0 ? ' selected' : '')});
      const img = createElement('img', {attrs:{src, alt: product.name + ' thumbnail ' + (idx+1)}});
      thumb.appendChild(img);
      thumb.addEventListener('click', () => {
        mainImg.src = src;
        document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('selected'));
        thumb.classList.add('selected');
      });
      thumbnails.appendChild(thumb);
    });
    gallery.appendChild(thumbnails);

    // Info
    const info = createElement('div', {classes:'product-detail-info'});
    info.appendChild(createElement('h2', {classes:'product-detail-name', text: product.name}));
    info.appendChild(createElement('div', {classes:'product-detail-category', text: 'Category: ' + product.category}));
    info.appendChild(createElement('div', {classes:'product-detail-price', text: formatPrice(product.price)}));
    info.appendChild(createElement('p', {classes:'product-detail-description', text: product.description}));

    // Variant selector if any
    if(product.variants && product.variants.length) {
      const varSelect = createElement('div', {classes:'variant-selector'});
      const label = createElement('label', {classes:'variant-label', text:'Select variant:'});
      varSelect.appendChild(label);
      const options = createElement('div', {classes:'variant-options'});
      product.variants.forEach(v => {
        const btn = createElement('button', {classes: 'variant-option' + (v.id === currentProductVariantId ? ' selected' : ''), text: v.name, attrs: {type: 'button'}});
        btn.addEventListener('click', () => {
          currentProductVariantId = v.id;
          document.querySelectorAll('.variant-option').forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
          // Update price
          priceDiv.textContent = formatPrice(v.price);
        });
        options.appendChild(btn);
      });
      varSelect.appendChild(options);
      info.appendChild(varSelect);
      varSelect.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('keydown', e => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            btn.click();
          }
        });
      });
    }

    // Price display (updates for variants)
    const priceDiv = createElement('div', {classes: 'product-detail-price', text: formatPrice(product.price)});
    info.appendChild(priceDiv);

    // Add to cart section
    const addSection = createElement('div', {classes:'add-to-cart-section'});
    const qtyInput = createElement('input', {attrs: {type:'number', min:1, max: product.stock, value:1, 'aria-label': 'Quantity'}} );
    addSection.appendChild(qtyInput);
    const btnAdd = createElement('button', {classes:'btn-primary', text:'Add to Cart', attrs: {type: 'button'}});
    btnAdd.addEventListener('click', () => {
      const qty = Math.min(Math.max(1, Number(qtyInput.value)), product.stock);
      addToCart(product.id, currentProductVariantId, qty);
      closeModal();
    });
    addSection.appendChild(btnAdd);
    info.appendChild(addSection);

    detailMain.appendChild(gallery);
    detailMain.appendChild(info);
    modal.appendChild(detailMain);

    // Reviews Section
    const reviewSection = createElement('section', {classes:'reviews', attrs:{'aria-label': 'Customer reviews'}});
    reviewSection.appendChild(createElement('h3', {classes:'reviews-header', text: 'Customer Reviews'}));
    const productReviews = reviews.filter(r => r.productId === product.id);
    if(productReviews.length === 0) {
      reviewSection.appendChild(createElement('p', {text:'No reviews yet.'}));
    } else {
      productReviews.forEach(r => {
        const reviewItem = createElement('article', {classes:'review-item'});
        const author = getUserById(r.userId)?.name || 'Anonymous';
        reviewItem.appendChild(createElement('div', {classes:'review-author', text: author}));
        const ratingDiv = createElement('div', {classes: 'review-rating'});
        for(let i=1; i<=5; i++) {
          ratingDiv.innerHTML += `<span class="material-icons star">${i <= r.rating ? 'star' : 'star_outline'}</span>`;
        }
        reviewItem.appendChild(ratingDiv);
        reviewItem.appendChild(createElement('p', {classes:'review-comment', text: r.comment}));
        reviewSection.appendChild(reviewItem);
      });
    }
    modal.appendChild(reviewSection);

    overlay.appendChild(modal);
    modalRoot.appendChild(overlay);

    // Focus trap & first focus
    btnClose.focus();
  }

  // Close modal
  function closeModal() {
    const modalRoot = document.getElementById('modal-root');
    modalRoot.innerHTML = '';
  }

  // ======= WISHLIST HANDLING =======
  function toggleWishlist(productId) {
    if(wishlist.includes(productId)) {
      wishlist = wishlist.filter(id => id !== productId);
      showToast('Removed from wishlist');
    } else {
      wishlist.push(productId);
      showToast('Added to wishlist');
    }
    localStorage.setItem('wishlist', JSON.stringify(wishlist));
    renderProducts();
    renderWishlist();
  }

  function renderWishlist() {
    // For demo, do nothing except update hearts on product cards
    document.querySelectorAll('.btn-small').forEach(btn => {
      if(!btn.textContent.includes('â™¡')) return;
      const card = btn.closest('.product-card');
      if(!card) return;
      const productName = card.querySelector('.product-name')?.textContent;
      if(!productName) return;
      const product = products.find(p => p.name === productName);
      if(!product) return;
      btn.style.color = wishlist.includes(product.id) ? '#7c3aed' : '#000000';
    });
  }

  // =========== BROWSING HISTORY & RECOMMENDATIONS ===========
  function addToBrowsingHistory(productId) {
    if(!browsingHistory.includes(productId)) {
      browsingHistory.push(productId);
      if(browsingHistory.length > 10) browsingHistory.shift();
      sessionStorage.setItem('browsingHistory', JSON.stringify(browsingHistory));
    }
    addToRecentlyViewed(productId);
    renderRecommendations();
    renderRecentlyViewed();
  }
  function addToRecentlyViewed(productId) {
    if(!recentlyViewed.includes(productId)) {
      recentlyViewed.push(productId);
      if(recentlyViewed.length > 6) recentlyViewed.shift();
      sessionStorage.setItem('recentlyViewed', JSON.stringify(recentlyViewed));
    }
  }

  // Simple recommendations based on browsingHistory tags
  function renderRecommendations() {
    const container = document.getElementById('recommendations-grid');
    container.innerHTML = '';
    if(browsingHistory.length === 0) {
      container.parentElement.hidden = true;
      return;
    }
    container.parentElement.hidden = false;
    // Collect tags of browsing products
    let tagsSet = new Set();
    browsingHistory.forEach(pid => {
      const prod = products.find(p => p.id === pid);
      if(prod) prod.tags.forEach(t => tagsSet.add(t));
    });
    // Recommend products that share tags and not in browsingHistory
    const recs = products.filter(p => p.tags.some(t => tagsSet.has(t)) && !browsingHistory.includes(p.id)).slice(0,6);
    if(recs.length === 0) {
      container.parentElement.hidden = true;
      return;
    }
    recs.forEach(p => {
      const card = createElement('article', {classes: 'product-card', attrs: {tabindex: 0, 'aria-label': `View details for ${p.name}`}});
      card.addEventListener('click', () => openProductDetail(p.id));
      card.addEventListener('keydown', e => {
        if(e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          openProductDetail(p.id);
        }
      });

      const imgDiv = createElement('div', {classes:'product-image'});
      const img = createElement('img', {attrs: {src: p.images[0], alt: p.name + ' product image'}});
      imgDiv.appendChild(img);
      card.appendChild(imgDiv);

      const info = createElement('div', {classes: 'product-info'});
      info.appendChild(createElement('header', {classes:'product-name', text: p.name }));
      info.appendChild(createElement('div', {classes:'product-category', text: p.category}));
      info.appendChild(createElement('div', {classes: 'product-price', text: formatPrice(p.price)}));
      card.appendChild(info);
      container.appendChild(card);
    });
  }

  function renderRecentlyViewed() {
    const container = document.getElementById('recently-viewed-grid');
    container.innerHTML = '';
    if(recentlyViewed.length === 0) {
      container.parentElement.hidden = true;
      return;
    }
    container.parentElement.hidden = false;
    recentlyViewed.forEach(pid => {
      const p = products.find(p => p.id === pid);
      if(!p) return;
      const card = createElement('article', {classes: 'product-card', attrs: {tabindex: 0, 'aria-label': `View details for ${p.name}`}});
      card.addEventListener('click', () => openProductDetail(p.id));
      card.addEventListener('keydown', e => {
        if(e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          openProductDetail(p.id);
        }
      });

      const imgDiv = createElement('div', {classes:'product-image'});
      const img = createElement('img', {attrs: {src: p.images[0], alt: p.name + ' product image'}});
      imgDiv.appendChild(img);
      card.appendChild(imgDiv);

      const info = createElement('div', {classes: 'product-info'});
      info.appendChild(createElement('header', {classes:'product-name', text: p.name }));
      info.appendChild(createElement('div', {classes:'product-category', text: p.category}));
      info.appendChild(createElement('div', {classes: 'product-price', text: formatPrice(p.price)}));
      card.appendChild(info);
      container.appendChild(card);
    });
  }

  // ============ SORT SELECT CHANGE ============
  document.getElementById('sort-select').addEventListener('change', e => {
    sorting = e.target.value;
    applyFilters();
  });

  // ============ CHECKOUT BUTTON ============
  document.getElementById('btn-checkout').addEventListener('click', () => {
    openCheckout();
  });

  // ============ MODAL CHECKOUT ==========
  function openCheckout() {
    const modalRoot = document.getElementById('modal-root');
    modalRoot.innerHTML = '';

    const overlay = createElement('div', {classes:'modal-overlay'});
    overlay.tabIndex = -1;
    overlay.addEventListener('click', e => {
      if(e.target === overlay) closeModal();
    });

    // Trap escape key
    overlay.addEventListener('keydown', e => {
      if(e.key === 'Escape') {
        e.preventDefault();
        closeModal();
      }
    });

    const modal = createElement('section', {classes:'modal', attrs: {role:'dialog', 'aria-modal':'true', 'aria-labelledby':'checkout-title'}});
    const btnClose = createElement('button', {classes:'modal-close-btn', html: '<span class="material-icons" aria-hidden="true">close</span>', attrs: {'aria-label': 'Close checkout dialog'}});
    btnClose.addEventListener('click', closeModal);
    modal.appendChild(btnClose);

    // Title and steps bar
    modal.appendChild(createElement('h2', {text:'Checkout', attrs:{id:'checkout-title'}, classes:'product-detail-name'}));
    const stepsBar = createElement('div', {classes: 'checkout-steps'});
    ['Cart','Shipping','Payment','Confirm'].forEach((label, idx) => {
      const stepDiv = createElement('div', {classes: 'step ' + (checkoutStep === idx ? 'active' : ''), html: `<span class="step-indicator">${label}</span>`});
      if(checkoutStep > idx) stepDiv.classList.add('completed');
      stepsBar.appendChild(stepDiv);
    });
    modal.appendChild(stepsBar);

    // Checkout content container
    const content = createElement('div', {classes:'checkout-content'});
    modal.appendChild(content);

    async function renderStep() {
      content.innerHTML = '';
      if(checkoutStep === 0) {
        // Cart review
        const cartReview = createElement('div');
        if(cart.length === 0) {
          cartReview.textContent = 'Your cart is empty.';
          const btnCloseCheckout = createElement('button', {text: 'Close', classes: 'btn-primary'});
          btnCloseCheckout.addEventListener('click', closeModal);
          cartReview.appendChild(btnCloseCheckout);
        } else {
          cart.forEach(ci => {
            const product = products.find(p => p.id === ci.productId);
            if(!product) return;
            const variant = product.variants?.find(v => v.id === ci.variantId) || null;
            const div = createElement('div', {text: `${product.name} - ${variant ? variant.name : ''} x${ci.quantity} - ${formatPrice(ci.price * ci.quantity)}`});
            cartReview.appendChild(div);
          });
          const nextBtn = createElement('button', {text:'Next', classes:'btn-primary'});
          nextBtn.addEventListener('click', () => {
            checkoutStep++;
            renderStep();
          });
          cartReview.appendChild(nextBtn);
        }
        content.appendChild(cartReview);
      } else if(checkoutStep === 1) {
        // Shipping & Billing form
        const form = createElement('form', {classes:'checkout-form', attrs:{'aria-label':'Shipping and billing information'}});
        let valName = currentUser?.name || '';
        let valEmail = currentUser?.email || '';
        let valAddress = currentUser?.addresses[0] || '';
        let valCountry = '';
        let valZip = '';
        // Name
        const groupName = createElement('label', {text:'Full Name'});
        const inputName = createElement('input', {attrs:{type:'text', required:'true', value: valName, 'aria-required': 'true'}});
        groupName.appendChild(inputName);
        form.appendChild(groupName);
        // Email
        const groupEmail = createElement('label', {text:'Email Address'});
        const inputEmail = createElement('input', {attrs:{type:'email', required:'true', value: valEmail, 'aria-required': 'true'}});
        groupEmail.appendChild(inputEmail);
        form.appendChild(groupEmail);
        // Address
        const groupAddress = createElement('label', {text:'Shipping Address'});
        const inputAddress = createElement('textarea', {attrs:{required:'true', 'aria-required':'true'}});
        inputAddress.value = valAddress;
        groupAddress.appendChild(inputAddress);
        form.appendChild(groupAddress);
        // Country
        const groupCountry = createElement('label', {text:'Country'});
        const selectCountry = createElement('select', {attrs:{required:'true', 'aria-required':'true'}});
        ['Select Country','USA','Canada','UK','Germany','France','Australia'].forEach(c => {
          const option = createElement('option', {text:c, attrs: {value: c === 'Select Country' ? '' : c}});
          selectCountry.appendChild(option);
        });
        groupCountry.appendChild(selectCountry);
        form.appendChild(groupCountry);
        // Zip Code
        const groupZip = createElement('label', {text:'Postal/Zip Code'});
        const inputZip = createElement('input', {attrs:{type:'text', required:'true', 'aria-required':'true'}});
        groupZip.appendChild(inputZip);
        form.appendChild(groupZip);

        // Validation message elements
        const validationMsg = createElement('div', {classes:'error-message', attrs:{role:'alert', 'aria-live':'assertive'}});
        form.appendChild(validationMsg);

        // Buttons container
        const btnContainer = createElement('div', {style: 'display:flex; gap:16px; margin-top:24px;'});
        const backBtn = createElement('button', {text:'Back', classes:'btn-small', attrs:{type:'button'}});
        backBtn.addEventListener('click', () => {
          checkoutStep--;
          renderStep();
        });
        btnContainer.appendChild(backBtn);
        const nextBtn = createElement('button', {text:'Next', classes:'btn-primary', attrs:{type:'submit'}});
        btnContainer.appendChild(nextBtn);
        form.appendChild(btnContainer);

        form.addEventListener('submit', e => {
          e.preventDefault();
          // Validate inputs
          if(inputName.value.trim() === '') {
            validationMsg.textContent = 'Full Name is required.';
            inputName.focus();
            return;
          }
          if(!/\S+@\S+\.\S+/.test(inputEmail.value.trim())) {
            validationMsg.textContent = 'A valid email is required.';
            inputEmail.focus();
            return;
          }
          if(inputAddress.value.trim() === '') {
            validationMsg.textContent = 'Shipping address is required.';
            inputAddress.focus();
            return;
          }
          if(selectCountry.value === '') {
            validationMsg.textContent = 'Please select a country.';
            selectCountry.focus();
            return;
          }
          if(inputZip.value.trim() === '') {
            validationMsg.textContent = 'Postal/Zip Code is required.';
            inputZip.focus();
            return;
          }
          validationMsg.textContent = '';
          checkoutShippingInfo = {
            name: inputName.value.trim(),
            email: inputEmail.value.trim(),
            address: inputAddress.value.trim(),
            country: selectCountry.value,
            zip: inputZip.value.trim()
          };
          checkoutStep++;
          renderStep();
        });

        content.appendChild(form);
        inputName.focus();

      } else if(checkoutStep === 2) {
        // Payment step (simulate)
        const paymentDiv = createElement('div');
        paymentDiv.appendChild(createElement('p', {text:'Payment will be processed securely (simulated). Choose your payment method:'}));
        const methods = ['Visa **** 1234', 'Mastercard **** 5678', 'PayPal'];
        let selectedMethod = null;
        const list = createElement('ul', {style:'list-style:none; padding:0;'});
        methods.forEach(m => {
          const li = createElement('li');
          const label = createElement('label');
          const radio = createElement('input', {attrs: {type:'radio', name:'payment-method', value:m}});
          label.appendChild(radio);
          label.appendChild(document.createTextNode(m));
          li.appendChild(label);
          list.appendChild(li);
        });
        paymentDiv.appendChild(list);

        const validationMsg = createElement('div', {classes:'error-message', attrs:{role:'alert', 'aria-live':'assertive'}});
        paymentDiv.appendChild(validationMsg);

        const btnContainer = createElement('div', {style: 'display:flex; gap:16px; margin-top:24px;'});
        const backBtn = createElement('button', {text:'Back', classes:'btn-small', attrs:{type:'button'}});
        backBtn.addEventListener('click', () => {
          checkoutStep--;
          renderStep();
        });
        btnContainer.appendChild(backBtn);
        const payBtn = createElement('button', {text:'Pay Now', classes:'btn-primary', attrs:{type:'button'}});
        btnContainer.appendChild(payBtn);

        payBtn.addEventListener('click', () => {
          const checked = paymentDiv.querySelector('input[name="payment-method"]:checked');
          if(!checked) {
            validationMsg.textContent = 'Please select a payment method.';
            return;
          }
          validationMsg.textContent = '';
          // Simulate payment processing and order creation
          processOrder(checked.value);
        });

        paymentDiv.appendChild(btnContainer);
        content.appendChild(paymentDiv);

      } else if(checkoutStep === 3) {
        // Confirmation step
        content.appendChild(createElement('p', {text:'Thank you for your purchase! Your order has been placed.'}));

        if(currentOrder) {
          content.appendChild(createElement('div', {html: `
            <p>Order ID: <strong>${currentOrder.id}</strong></p>
            <p>Status: <strong>${currentOrder.status}</strong></p>
            <p>Total: <strong>${formatPrice(currentOrder.total)}</strong></p>
          `}));
        }

        const btnCloseCheckout = createElement('button', {text: 'Close', classes: 'btn-primary'});
        btnCloseCheckout.addEventListener('click', () => {
          closeModal();
          clearCartAfterOrder();
        });
        content.appendChild(btnCloseCheckout);
      }
    }

    renderStep();
    modalRoot.appendChild(overlay);
  }

  let checkoutShippingInfo = null;

  // =========== PROCESS ORDER SIMULATION ===========
  async function processOrder(paymentMethod) {
    const content = document.querySelector('.checkout-content');
    content.innerHTML = '<p>Processing your order, please wait...</p>';
    await delay(1500);

    // Create order object
    const orderId = uuid();
    const orderItems = cart.map(ci => ({
      productId: ci.productId,
      variantId: ci.variantId,
      quantity: ci.quantity,
      price: ci.price
    }));
    const totalAmount = cart.reduce((acc, ci) => acc + ci.price * ci.quantity, 0);
    currentOrder = {
      id: orderId,
      userId: currentUser?.id || null,
      items: orderItems,
      total: totalAmount,
      status: 'Processing',
      shipping: checkoutShippingInfo,
      billing: {paymentMethod},
      tracking: null,
      createdAt: new Date().toISOString()
    };
    orders.push(currentOrder);

    checkoutStep++;
    renderCheckoutStepAfterOrder();
  }

  function renderCheckoutStepAfterOrder() {
    const content = document.querySelector('.checkout-content');
    content.innerHTML = '<p>Thank you for your purchase! Your order has been placed.</p>';
    content.appendChild(createElement('p', {html:`<strong>Order ID:</strong> ${currentOrder.id}`}));
    // Simulate tracking info
    const statusP = createElement('p', {html: `<strong>Status:</strong> <span id="order-status">${currentOrder.status}</span>`});
    content.appendChild(statusP);
    content.appendChild(createElement('p', {html:`<strong>Total:</strong> ${formatPrice(currentOrder.total)}`}));
    const btnClose = createElement('button', {text: 'Close', classes: 'btn-primary'});
    btnClose.addEventListener('click', () => {
      closeModal();
      clearCartAfterOrder();
    });
    content.appendChild(btnClose);
    simulateOrderTracking();
  }

  async function simulateOrderTracking() {
    if (!currentOrder) return;
    const statusSpan = document.getElementById('order-status');
    const stages = ['Processing', 'Shipped', 'Out for Delivery', 'Delivered'];
    for(let i = 1; i < stages.length; i++) {
      await delay(4000);
      currentOrder.status = stages[i];
      statusSpan.textContent = stages[i];
    }
  }

  function clearCartAfterOrder() {
    cart = [];
    updateCart();
    checkoutStep = 0;
    currentOrder = null;
  }

  // ============ NAVIGATION LINKS =========
  document.getElementById('nav-home').addEventListener('click', e => {
    e.preventDefault();
    if(e.target.classList.contains('active')) return;
    setActiveNav('home');
    // Reset filters and sorting and render products
    productFilters = {category: new Set(), priceMin: 0, priceMax: 2000, minRating: 0, brands: new Set()};
    sorting = 'popularity';
    pagination.currentPage = 1;
    renderFilters();
    applyFilters();
    hideAccountSection();
  });

  document.getElementById('nav-account').addEventListener('click', e => {
    e.preventDefault();
    if(e.target.classList.contains('active')) return;
    setActiveNav('account');
    showAccountSection();
  });

  function setActiveNav(name) {
    ['home','account'].forEach(n => {
      document.getElementById('nav-'+n).classList.toggle('active', n === name);
    });
  }

  // Hide account section, show products etc
  function hideAccountSection() {
    // For now no separate section, just hide modals and reset to product grid view
    closeModal();
  }
  // Show account section modal with order history and wishlist
  function showAccountSection() {
    if(!currentUser) {
      alert('Not logged in.');
      return;
    }
    const modalRoot = document.getElementById('modal-root');
    modalRoot.innerHTML = '';
    const overlay = createElement('div', {classes:'modal-overlay'});
    overlay.tabIndex = -1;
    overlay.addEventListener('click', e => {
      if(e.target === overlay) closeModal();
    });
    overlay.addEventListener('keydown', e => {
      if(e.key === 'Escape') {
        e.preventDefault();
        closeModal();
      }
    });

    const modal = createElement('section', {classes:'modal', attrs: {role:'dialog', 'aria-modal':'true', 'aria-labelledby':'account-title'}});
    const btnClose = createElement('button', {classes:'modal-close-btn', html: '<span class="material-icons" aria-hidden="true">close</span>', attrs: {'aria-label': 'Close account dialog'}});
    btnClose.addEventListener('click', closeModal);
    modal.appendChild(btnClose);

    modal.appendChild(createElement('h2', {text:`Welcome, ${currentUser.name}`, attrs:{id:'account-title'}, classes:'product-detail-name'}));

    // Wishlist list
    const wishlistSection = createElement('section', {attrs: {'aria-label': 'Your Wishlist'}});
    wishlistSection.appendChild(createElement('h3', {classes:'section-title',text:'Wishlist'}));
    if(currentUser.wishlist.length === 0) {
      wishlistSection.appendChild(createElement('p', {text:'Your wishlist is empty.'}));
    } else {
      const list = createElement('ul', {style: 'list-style:none; padding: 0; display: grid; grid-template-columns: repeat(auto-fill,minmax(200px,1fr)); gap: 12px;'});
      currentUser.wishlist.forEach(pid => {
        const p = products.find(p => p.id === pid);
        if(!p) return;
        const item = createElement('li');
        const link = createElement('a', {text: p.name, attrs: {href:'#', tabindex: 0}});
        link.addEventListener('click', e => {
          e.preventDefault();
          closeModal();
          openProductDetail(p.id);
        });
        item.appendChild(link);
        list.appendChild(item);
      });
      wishlistSection.appendChild(list);
    }
    modal.appendChild(wishlistSection);

    // Order History
    const ordersSection = createElement('section', {attrs: {'aria-label': 'Your Orders'}});
    ordersSection.appendChild(createElement('h3', {classes:'section-title', text:'Order History'}));
    if(currentUser.orderHistory.length === 0) {
      ordersSection.appendChild(createElement('p', {text:'You have no past orders.'}));
    } else {
      currentUser.orderHistory.forEach(oid => {
        const order = orders.find(o => o.id === oid);
        if(!order) return;
        const div = createElement('div', {style:'border: 1px solid #d1d5db; border-radius: 12px; margin-bottom: 12px; padding: 12px;'});
        div.appendChild(createElement('p', {html: `<strong>Order ID:</strong> ${order.id}`}));
        div.appendChild(createElement('p', {html: `<strong>Status:</strong> ${order.status}`}));
        div.appendChild(createElement('p', {html: `<strong>Total:</strong> ${formatPrice(order.total)}`}));
        // Estimated delivery (simulate 5 days after order)
        const estDelivery = new Date(order.createdAt);
        estDelivery.setDate(estDelivery.getDate() + 5);
        div.appendChild(createElement('p', {html: `<strong>Est. Delivery:</strong> ${estDelivery.toLocaleDateString()}`}));
        // View details button
        const btnDetails = createElement('button', {text: 'View Details', classes: 'btn-small', attrs: {type: 'button'}});
        btnDetails.addEventListener('click', () => {
          showOrderDetails(order);
        });
        div.appendChild(btnDetails);
        // Reorder button
        const btnReorder = createElement('button', {text: 'Reorder', classes: 'btn-small', attrs: {type: 'button', style: 'margin-left:8px;'}});
        btnReorder.addEventListener('click', () => {
          reorderOrder(order);
        });
        div.appendChild(btnReorder);
        // Track order button
        const btnTrack = createElement('button', {text: 'Track Order', classes: 'btn-small', attrs: {type: 'button', style: 'margin-left:8px;'}});
        btnTrack.addEventListener('click', () => {
          showOrderTracking(order);
        });
        div.appendChild(btnTrack);
        ordersSection.appendChild(div);
      });
    }
    modal.appendChild(ordersSection);

    // Wishlist clear all button
    if(currentUser.wishlist.length > 0) {
      const clearBtn = createElement('button', {text: 'Clear Wishlist', classes: 'btn-small', attrs: {type: 'button', style: 'margin-top:8px;'}});
      clearBtn.addEventListener('click', () => {
        currentUser.wishlist = [];
        localStorage.setItem('wishlist', JSON.stringify([]));
        renderWishlist();
        showAccountSection();
      });
      wishlistSection.appendChild(clearBtn);
    }

    overlay.appendChild(modal);
    modalRoot.appendChild(overlay);
    btnClose.focus();
  }

  // ========== INITIAL SETUP ===========
  function init() {
    renderFilters();
    applyFilters();
    updateCart();
    renderWishlist();
    renderRecommendations();
    renderRecentlyViewed();
  }

  init();

  // Add helper functions for new features
  function showOrderDetails(order) {
    const modalRoot = document.getElementById('modal-root');
    modalRoot.innerHTML = '';
    const overlay = createElement('div', {classes:'modal-overlay'});
    overlay.tabIndex = -1;
    overlay.addEventListener('click', e => {
      if(e.target === overlay) closeModal();
    });
    overlay.addEventListener('keydown', e => {
      if(e.key === 'Escape') {
        e.preventDefault();
        closeModal();
      }
    });
    const modal = createElement('section', {classes:'modal', attrs: {role:'dialog', 'aria-modal':'true', 'aria-labelledby':'order-detail-title'}});
    const btnClose = createElement('button', {classes:'modal-close-btn', html: '<span class="material-icons" aria-hidden="true">close</span>', attrs: {'aria-label': 'Close order details'}});
    btnClose.addEventListener('click', closeModal);
    modal.appendChild(btnClose);
    modal.appendChild(createElement('h2', {text: `Order Details`, attrs:{id:'order-detail-title'}, classes:'product-detail-name'}));
    modal.appendChild(createElement('p', {html: `<strong>Order ID:</strong> ${order.id}`}));
    modal.appendChild(createElement('p', {html: `<strong>Status:</strong> ${order.status}`}));
    modal.appendChild(createElement('p', {html: `<strong>Total:</strong> ${formatPrice(order.total)}`}));
    // Estimated delivery
    const estDelivery = new Date(order.createdAt);
    estDelivery.setDate(estDelivery.getDate() + 5);
    modal.appendChild(createElement('p', {html: `<strong>Est. Delivery:</strong> ${estDelivery.toLocaleDateString()}`}));
    // Shipping info
    if(order.shipping) {
      modal.appendChild(createElement('h3', {text: 'Shipping Info'}));
      modal.appendChild(createElement('p', {text: `${order.shipping.name}, ${order.shipping.address}, ${order.shipping.country}, ${order.shipping.zip}`}));
    }
    // Items
    modal.appendChild(createElement('h3', {text: 'Items'}));
    const ul = createElement('ul');
    order.items.forEach(item => {
      const product = products.find(p => p.id === item.productId);
      if(!product) return;
      let text = `${product.name}`;
      if(item.variantId) {
        const variant = product.variants?.find(v => v.id === item.variantId);
        if(variant) text += ` (${variant.name})`;
      }
      text += ` x${item.quantity} - ${formatPrice(item.price * item.quantity)}`;
      ul.appendChild(createElement('li', {text}));
    });
    modal.appendChild(ul);
    overlay.appendChild(modal);
    modalRoot.appendChild(overlay);
    btnClose.focus();
  }

  function reorderOrder(order) {
    order.items.forEach(item => {
      addToCart(item.productId, item.variantId, item.quantity);
    });
    showToast('Order items added to cart!');
  }

  function showOrderTracking(order) {
    const modalRoot = document.getElementById('modal-root');
    modalRoot.innerHTML = '';
    const overlay = createElement('div', {classes:'modal-overlay'});
    overlay.tabIndex = -1;
    overlay.addEventListener('click', e => {
      if(e.target === overlay) closeModal();
    });
    overlay.addEventListener('keydown', e => {
      if(e.key === 'Escape') {
        e.preventDefault();
        closeModal();
      }
    });
    const modal = createElement('section', {classes:'modal', attrs: {role:'dialog', 'aria-modal':'true', 'aria-labelledby':'order-track-title'}});
    const btnClose = createElement('button', {classes:'modal-close-btn', html: '<span class="material-icons" aria-hidden="true">close</span>', attrs: {'aria-label': 'Close tracking'}});
    btnClose.addEventListener('click', closeModal);
    modal.appendChild(btnClose);
    modal.appendChild(createElement('h2', {text: `Order Tracking`, attrs:{id:'order-track-title'}, classes:'product-detail-name'}));
    // Tracking history (simulate)
    const stages = ['Processing', 'Shipped', 'Out for Delivery', 'Delivered'];
    const created = new Date(order.createdAt);
    const now = new Date();
    const ul = createElement('ul');
    stages.forEach((stage, idx) => {
      const li = createElement('li');
      let date = new Date(created);
      date.setDate(date.getDate() + idx);
      li.textContent = `${stage} - ${date.toLocaleDateString()}${stage === order.status ? ' (current)' : ''}`;
      if(stage === order.status) li.style.fontWeight = 'bold';
      ul.appendChild(li);
    });
    modal.appendChild(ul);
    overlay.appendChild(modal);
    modalRoot.appendChild(overlay);
    btnClose.focus();
  }
})();
</script>
</body>
</html>

